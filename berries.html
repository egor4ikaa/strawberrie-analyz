<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∑–µ–º–ª—è–Ω–∏–∫–∏ —Å–∞–¥–æ–≤–æ–π v1.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.8.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    <link src="stylesheet" href="berries.css">
</head>
<body>
    <h1>üçì –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∫–ª—É–±–Ω–∏–∫–∏</h1>
    <p class="description">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –∫—É—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–ø–µ–ª–æ—Å—Ç–∏ —è–≥–æ–¥</p>
    
    <div id="webcam-container">
        <video id="webcam" autoplay playsinline></video>
    </div>
    
    <div id="controls">
        <button id="start">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
        <button id="stop" style="background: var(--unripe); display: none;">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    </div>
    
    <div class="loading">
        <div class="spinner"></div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...</p>
    </div>
    
    <div id="results" style="display: none;">
        <div class="counters">
            <h3>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —è–≥–æ–¥</h3>
            <div class="counter">
                <div class="counter-color" style="background: var(--ripe);"></div>
                <span id="ripe-count">0</span> —Å–ø–µ–ª—ã—Ö
            </div>
            <div class="counter">
                <div class="counter-color" style="background: var(--unripe);"></div>
                <span id="unripe-count">0</span> –Ω–µ—Å–ø–µ–ª—ã—Ö
            </div>
        </div>
        
        <div id="chart-container">
            <canvas id="chart"></canvas>
        </div>
    </div>
    
    <script>
        const URL = "https://teachablemachine.withgoogle.com/models/-gv8z_sYx/";
        let model, webcam, maxPredictions;
        let chart = null;
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const startBtn = document.getElementById('start');
        const stopBtn = document.getElementById('stop');
        const loadingDiv = document.querySelector('.loading');
        const resultsDiv = document.getElementById('results');
        const ripeCountEl = document.getElementById('ripe-count');
        const unripeCountEl = document.getElementById('unripe-count');
        const chartCanvas = document.getElementById('chart');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        startBtn.addEventListener('click', init);
        stopBtn.addEventListener('click', stopCamera);
        
        async function init() {
            try {
                startBtn.disabled = true;
                loadingDiv.style.display = 'block';
                
                // 1. –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }, 
                    audio: false 
                });
                
                // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏
                model = await tmImage.load(URL + "model.json", URL + "metadata.json");
                maxPredictions = model.getTotalClasses();
                
                // 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–º–µ—Ä—ã
                webcam = new tmImage.Webcam(400, 400, true);
                await webcam.setup(stream);
                await webcam.play();
                document.getElementById('webcam-container').appendChild(webcam.canvas);
                
                // 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã
                initChart();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                loadingDiv.style.display = 'none';
                resultsDiv.style.display = 'flex';
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
                window.requestAnimationFrame(loop);
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞:", error);
                alert(`–û—à–∏–±–∫–∞: ${error.message}`);
                loadingDiv.style.display = 'none';
                startBtn.disabled = false;
            }
        }
        
        function stopCamera() {
            if (webcam) {
                webcam.stop();
                document.getElementById('webcam-container').removeChild(webcam.canvas);
            }
            stopBtn.style.display = 'none';
            startBtn.style.display = 'block';
            startBtn.disabled = false;
        }
        
        async function loop() {
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }
        
        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            let ripeCount = 0;
            let unripeCount = 0;
            
            for (let i = 0; i < maxPredictions; i++) {
                if (prediction[i].className === "–°–ø–µ–ª—ã–µ" && prediction[i].probability > 0.7) {
                    ripeCount++;
                } else if (prediction[i].className === "–ù–µ—Å–ø–µ–ª—ã–µ" && prediction[i].probability > 0.7) {
                    unripeCount++;
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            ripeCountEl.textContent = ripeCount;
            unripeCountEl.textContent = unripeCount;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É
            updateChart(ripeCount, unripeCount);
        }
        
        function initChart() {
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º Chart.js –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
            script.onload = () => {
                chart = new Chart(chartCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: ['–°–ø–µ–ª—ã–µ', '–ù–µ—Å–ø–µ–ª—ã–µ'],
                        datasets: [{
                            data: [0, 0],
                            backgroundColor: [
                                'rgba(255, 107, 107, 0.8)',
                                'rgba(78, 205, 196, 0.8)'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            };
            document.head.appendChild(script);
        }
        
        function updateChart(ripe, unripe) {
            if (!chart) return;
            
            chart.data.datasets[0].data = [ripe, unripe];
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã
            const total = ripe + unripe;
            if (total > 0) {
                const ripePercent = Math.round((ripe / total) * 100);
                const unripePercent = 100 - ripePercent;
                chart.data.labels = [
                    `–°–ø–µ–ª—ã–µ ${ripePercent}%`,
                    `–ù–µ—Å–ø–µ–ª—ã–µ ${unripePercent}%`
                ];
            }
            
            chart.update();
        }
    </script>
</body>
</html>